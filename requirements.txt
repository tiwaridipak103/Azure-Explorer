import multiprocessing as mp
import traceback
from typing import Callable, Any, Tuple

def multiprocess_decorator(worker_fn: Callable[..., Any]):

    def safe_worker(idx, *args):
        try:
            worker_fn(idx, *args)
        except Exception:
            print(f"\n‚ùå Exception in worker {idx}")
            print(traceback.format_exc())
            raise

    def wrapper(*args: Tuple[Any, ...]):
        iteration, *remaining_args = args

        ctx = mp.get_context("spawn")  # CRITICAL
        processes = []

        for i in range(iteration):
            p = ctx.Process(
                target=safe_worker,
                args=(i, *remaining_args)
            )
            p.start()
            processes.append(p)

        for p in processes:
            p.join(timeout=300)  # avoid infinite hang
            if p.exitcode != 0:
                raise RuntimeError(
                    f"Worker process {p.pid} failed with exit code {p.exitcode}"
                )

    return wrapper